name: Build and Publish

on:
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            publish:
                description: "Publish to PyPI (only for releases)"
                required: false
                default: false
                type: boolean

# Cancel any in-progress build when a new commit is pushed
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Build the sdist and pure Python wheel
    sdist-and-wheel:
        name: Build sdist and pure wheel
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Needed for hatch-vcs versioning

            - name: Set up uv
              uses: astral-sh/setup-uv@v5
              with:
                  python-version: "3.12"

            - name: Build sdist and wheel
              run: uv build

            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: sdist
                  path: dist/*.tar.gz

            - name: Upload wheel
              uses: actions/upload-artifact@v4
              with:
                  name: wheel-pure
                  path: dist/*.whl

    # Generate the wheel build matrix dynamically
    generate-wheels-matrix:
        name: Generate wheels matrix
        runs-on: ubuntu-latest
        outputs:
            include: ${{ steps.set-matrix.outputs.include }}
        steps:
            - uses: actions/checkout@v4
            - name: Set up uv
              uses: astral-sh/setup-uv@v5
            - name: Install cibuildwheel and generate matrix
              run: |
                  uvx cibuildwheel==2.22.0 --print-build-identifiers --platform linux \
                  | jq -nRc '{"only": inputs, "os": "ubuntu-latest"}' > /tmp/linux_builds.json
                  uvx cibuildwheel==2.22.0 --print-build-identifiers --platform macos \
                  | jq -nRc '{"only": inputs, "os": "macos-14"}' > /tmp/macos_builds.json
                  uvx cibuildwheel==2.22.0 --print-build-identifiers --platform windows \
                  | jq -nRc '{"only": inputs, "os": "windows-latest"}' > /tmp/windows_builds.json
            - name: Merge matrices
              id: set-matrix
              run: |
                  jq -sc 'add' /tmp/*_builds.json > /tmp/matrix.json
                  MATRIX=$(cat /tmp/matrix.json)
                  echo "include=$MATRIX" >> "$GITHUB_OUTPUT"

    # Build mypyc-compiled wheels using cibuildwheel
    mypyc-wheels:
        name: Build ${{ matrix.only }}
        needs: generate-wheels-matrix
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include: ${{ fromJson(needs.generate-wheels-matrix.outputs.include) }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Build wheels
              uses: pypa/cibuildwheel@v2.22.0
              with:
                  only: ${{ matrix.only }}
              env:
                  CIBW_BUILD_VERBOSITY: 1

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheel-${{ matrix.only }}
                  path: wheelhouse/*.whl

    # Publish to PyPI using trusted publishing
    publish:
        name: Publish to PyPI
        needs: [sdist-and-wheel, mypyc-wheels]
        runs-on: ubuntu-latest
        # Only publish on release events or manual trigger with publish=true
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.publish)
        environment:
            name: pypi
            url: https://pypi.org/p/plum-dispatch
        permissions:
            id-token: write # Required for trusted publishing
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: List artifacts
              run: ls -la dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/
